/** @file main.c
 *  @brief Initialization and system starting point.
 *
 *  Right now we just initialize the PRUs and loop through looking for keyboard input
 *  to initiate a servo action (like playing a page), and taking a frame of video and
 *  processing it with OpenCV color range matching and moments recognition.
 *
 *  @author Bill Merryman
 *  @bug No known bugs.
 *
 *  Created on: Oct 16, 2015
 *
 */

#include <limits.h>
#include <stdlib.h>
#include <stdio.h>
#include <stdint.h>
#include <unistd.h>

#include "cv.h"
#include "highgui.h"
#include "pru.h"
#include "PRUInterop.h"
#include "motionManager.h"
#include "visionManager.hpp"

int main (int argc, char *argv[])
{

	if(argv < 6)
	{
		fprintf(stderr, "Usage: BioloidBeaglebone PRU0Firmware PRU1Firmware MotionFile MLProtoFile MLCaffeFile");
		return -1;
	}

	const char *PRU0Firmware = realpath(argv[1], null);
	const char *PRU1Firmware = realpath(argv[2], null);
	const char *motionFile = realpath(argv[3], null);
	const char *protoFile = realpath(argv[4], null);
	const char *caffeFile = realpath(argv[5], null);

	int key = 0;

	initializePRU(PRU0Firmware, PRU1Firmware);

	motionManagerInitialize(motionFile);
	visionManagerInitialize(protoFile, caffeFile);

	while(key != 'x')
	{
		visionManagerProcess();
		motionManagerProcess(key);
		key = cvWaitKey(25);
	}

	visionManagerUninitialize();
	stopPRU_0();
	stopPRU_1();
}
